<script context="module">
  export const key = 'Animate';

  export const defaults = {
    // Use animate.css to animate the notice.
    animate: false,
    // The class to use to animate the notice in.
    inClass: '',
    // The class to use to animate the notice out.
    outClass: ''
  };
</script>
<script>
  // The PNotify notice.
  export let _notice = null;

  export let animate = defaults.animate;
  export let inClass = defaults.inClass;
  export let outClass = defaults.outClass;

  let _animateIn;
  let _animateOut;
  let _animation;

  $: {
    if (animate && !_animateIn) {
      _animation = _notice.animation;
      _animateIn = _notice.animateIn;
      _animateOut = _notice.animateOut;
      _notice.$set({
        animation: 'none',
        animateIn,
        animateOut
      });
    } else if (!animate && _animateIn) {
      _notice.$set({
        animation: _animation,
        animateIn: _animateIn,
        animateOut: _animateOut
      });
      _animation = null;
      _animateIn = null;
      _animateOut = null;
    }
  }

  $: {
    if (animate && _notice.refs.elem) {
      var animSpeed = 250;
      if (_notice.animateSpeed === 'slow') {
        animSpeed = 400;
      } else if (_notice.animateSpeed === 'fast') {
        animSpeed = 100;
      } else if (_notice.animateSpeed > 0) {
        animSpeed = _notice.animateSpeed;
      }
      animSpeed = animSpeed / 1000;
      _notice.refs.elem.style.animationDuration = animSpeed + 's';
    }
  }

  function animateIn (callback, immediate) {
    // Declare that the notice is animating in.
    _notice.setAnimating('in');

    let off;
    const finished = event => {
      if (event && _notice.refs.elem && event.target !== _notice.refs.elem) {
        return;
      }
      off();
      _notice.setAnimatingClass('ui-pnotify-in animated');
      if (callback) {
        callback.call();
      }
      // Declare that the notice has completed animating.
      _notice.setAnimating(false);
    };

    off = _notice.on('animationend', finished);
    if (immediate) {
      finished();
    } else {
      _notice.setAnimatingClass('ui-pnotify-in animated ' + inClass);
    }
  }

  function animateOut (callback, immediate) {
    // Declare that the notice is animating out.
    _notice.setAnimating('out');

    let off;
    const finished = event => {
      if (event && _notice.refs.elem && event.target !== _notice.refs.elem) {
        return;
      }
      off();
      _notice.setAnimatingClass('animated');
      if (callback) {
        callback.call();
      }
      // Declare that the notice has completed animating.
      if (_notice.setAnimating) {
        _notice.setAnimating(false);
      }
    };

    off = _notice.on('animationend', finished);
    if (immediate) {
      finished();
    } else {
      _notice.setAnimatingClass('ui-pnotify-in animated ' + outClass);
    }
  }

  export const attention = (aniClass, callback) => {
    let off;
    const cb = () => {
      off();
      _notice.removeModuleClass('container', 'animated', aniClass);
      if (callback) {
        callback.call(_notice);
      }
    };
    off = _notice.on('animationend', cb);
    _notice.addModuleClass('container', 'animated', aniClass);
  };
</script>
